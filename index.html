<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Шашки с Кошпеичками</title>
    <style>
        body { font-family: Arial; text-align: center; }
        #auth { margin: 20px; }
        #friends { margin: 20px; }
        #game { display: none; }
        table { margin: auto; border-collapse: collapse; }
        td { width: 50px; height: 50px; text-align: center; vertical-align: middle; }
        .black { background: black; }
        .white { background: white; }
        .piece { font-size: 30px; cursor: pointer; }
        .red { color: red; }
        .black-piece { color: black; }
        .selected { border: 2px solid green; }
        #status { margin: 10px; font-size: 20px; }
        #currency { margin: 10px; }
        #error { color: red; margin: 10px; }
    </style>
    <!-- Firebase Modular SDK v10.14.1 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getDatabase, ref, set, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

        window.firebaseModules = { initializeApp, getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, getDatabase, ref, set, onValue, push, update, remove };
    </script>
</head>
<body>
    <div id="auth">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Пароль (минимум 6 символов)">
        <button onclick="register()">Регистрация</button>
        <button onclick="login()">Вход</button>
        <button onclick="logout()">Выход</button>
        <div id="error"></div>
    </div>
    <div id="friends" style="display:none;">
        <h3>Друзья</h3>
        <input id="friendEmail" placeholder="Email друга">
        <button onclick="addFriend()">Добавить друга</button>
        <ul id="friendsList"></ul>
        <button onclick="startGame()">Создать игру</button>
        <input id="gameId" placeholder="ID игры друга">
        <button onclick="joinGame()">Присоединиться</button>
    </div>
    <div id="currency"></div>
    <div id="game">
        <h2>Шашки</h2>
        <table id="board"></table>
        <div id="status"></div>
    </div>

    <script type="module">
        // Импорт модулей (для глобального доступа)
        const { initializeApp, getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, getDatabase, ref, set, onValue, push, update, remove } = window.firebaseModules;

        // Firebase config (ЗАМЕНИТЕ НА СВОЙ!)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let user = null;
        let gameRef = null;
        let playerColor = null;
        let board = [];
        let selectedPiece = null;
        let turn = 'red';
        let currency = 0;
        let userRef = null;

        onAuthStateChanged(auth, u => {
            user = u;
            if (user) {
                document.getElementById('auth').style.display = 'none';
                document.getElementById('friends').style.display = 'block';
                userRef = ref(db, `users/${user.uid}`);
                loadFriends();
                loadCurrency();
            } else {
                document.getElementById('auth').style.display = 'block';
                document.getElementById('friends').style.display = 'none';
                document.getElementById('game').style.display = 'none';
            }
        });

        window.register = async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            errorDiv.innerText = ''; // Очистка ошибок

            if (!email || !password) {
                errorDiv.innerText = 'Введите email и пароль!';
                return;
            }
            if (password.length < 6) {
                errorDiv.innerText = 'Пароль слишком короткий (минимум 6 символов)!';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log('Успешная регистрация:', userCredential.user);
                // Инициализация пользователя в DB
                await set(ref(db, `users/${userCredential.user.uid}`), { currency: 0, friends: {} });
                errorDiv.innerText = 'Регистрация успешна!';
            } catch (error) {
                console.error('Ошибка регистрации:', error);
                let msg = 'Ошибка: ';
                switch (error.code) {
                    case 'auth/email-already-in-use': msg += 'Email уже используется!'; break;
                    case 'auth/weak-password': msg += 'Слабый пароль!'; break;
                    case 'auth/invalid-email': msg += 'Неверный email!'; break;
                    default: msg += error.message;
                }
                errorDiv.innerText = msg;
            }
        };

        window.login = async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            errorDiv.innerText = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorDiv.innerText = 'Ошибка входа: ' + error.message;
            }
        };

        window.logout = () => {
            signOut(auth).catch(console.error);
        };

        function loadCurrency() {
            onValue(ref(db, `users/${user.uid}/currency`), snap => {
                currency = snap.val() || 0;
                document.getElementById('currency').innerText = `Кошпеички: ${currency}`;
            });
        }

        function updateCurrency(amount) {
            set(ref(db, `users/${user.uid}/currency`), currency + amount);
        }

        window.addFriend = () => {
            const friendEmail = document.getElementById('friendEmail').value;
            push(ref(db, `users/${user.uid}/friends`), friendEmail);
        };

        function loadFriends() {
            const list = document.getElementById('friendsList');
            onValue(ref(db, `users/${user.uid}/friends`), snap => {
                list.innerHTML = '';
                snap.forEach(child => {
                    const li = document.createElement('li');
                    li.innerText = child.val();
                    list.appendChild(li);
                });
            });
        }

        // Остальной код игры (без изменений, кроме ref/set)
        window.startGame = () => {
            const gameId = Date.now().toString();
            gameRef = ref(db, `games/${gameId}`);
            playerColor = 'red';
            initBoard();
            set(gameRef, { board: board.flat(), turn: 'red', players: [user.uid], status: 'waiting' });
            alert(`ID игры: ${gameId}. Поделитесь с другом.`);
            listenToGame();
            document.getElementById('game').style.display = 'block';
        };

        window.joinGame = () => {
            const gameId = document.getElementById('gameId').value;
            gameRef = ref(db, `games/${gameId}`);
            playerColor = 'black';
            update(gameRef, { players: [...(await onValue(gameRef)).players, user.uid], status: 'started' });
            listenToGame();
            document.getElementById('game').style.display = 'block';
        };

        function listenToGame() {
            onValue(gameRef, snap => {
                const data = snap.val();
                if (data) {
                    board = [];
                    for (let i = 0; i < 8; i++) {
                        board.push(data.board.slice(i*8, (i+1)*8));
                    }
                    turn = data.turn;
                    renderBoard();
                    checkWin(data);
                    document.getElementById('status').innerText = turn === playerColor ? 'Ваш ход' : 'Ход оппонента';
                }
            });
        }

        function initBoard() {
            board = Array(8).fill().map(() => Array(8).fill(null));
            for (let row = 0; row < 3; row++) {
                for (let col = (row % 2 === 0 ? 1 : 0); col < 8; col += 2) {
                    board[row][col] = 'black';
                }
            }
            for (let row = 5; row < 8; row++) {
                for (let col = (row % 2 === 0 ? 1 : 0); col < 8; col += 2) {
                    board[row][col] = 'red';
                }
            }
        }

        function renderBoard() {
            const table = document.getElementById('board');
            table.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                const tr = document.createElement('tr');
                for (let col = 0; col < 8; col++) {
                    const td = document.createElement('td');
                    td.className = (row + col) % 2 === 0 ? 'white' : 'black';
                    if (board[row][col]) {
                        const piece = document.createElement('div');
                        piece.className = `piece ${board[row][col]}`;
                        piece.innerText = '⛀';
                        if (board[row][col].includes('king')) piece.innerText = '⛁';
                        piece.onclick = () => selectPiece(row, col);
                        td.appendChild(piece);
                    } else {
                        td.onclick = () => movePiece(row, col);
                    }
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
        }

        function selectPiece(row, col) {
            if (!board[row][col]?.startsWith(playerColor) || turn !== playerColor) return;
            selectedPiece = { row, col };
            renderBoard();
        }

        function movePiece(toRow, toCol) {
            if (!selectedPiece || turn !== playerColor) return;
            const { row, col } = selectedPiece;
            if (Math.abs(toRow - row) === 1 && Math.abs(toCol - col) === 1 && !board[toRow][toCol]) {
                board[toRow][toCol] = board[row][col];
                board[row][col] = null;
                if (playerColor === 'red' && toRow === 0) board[toRow][toCol] += '-king';
                if (playerColor === 'black' && toRow === 7) board[toRow][toCol] += '-king';
                if (Math.abs(toRow - row) === 2) {
                    const midRow = (row + toRow) / 2;
                    const midCol = (col + toCol) / 2;
                    board[midRow][midCol] = null;
                }
                turn = turn === 'red' ? 'black' : 'red';
                update(gameRef, { board: board.flat(), turn });
            }
            selectedPiece = null;
            renderBoard();
        }

        function checkWin(data) {
            const redCount = board.flat().filter(p => p?.startsWith('red')).length;
            const blackCount = board.flat().filter(p => p?.startsWith('black')).length;
            if (redCount === 0) {
                alert('Черные выиграли!');
                updateCurrency(playerColor === 'black' ? 10 : -5);
                remove(gameRef);
            } else if (blackCount === 0) {
                alert('Красные выиграли!');
                updateCurrency(playerColor === 'red' ? 10 : -5);
                remove(gameRef);
            }
        }

        // Инициализация (для теста)
        initBoard();
        renderBoard();
    </script>
</body>
</html>
