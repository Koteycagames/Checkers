<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Шашки с Кошпеичками</title>
    <style>
        body { font-family: Arial; text-align: center; }
        #auth { margin: 20px; }
        #friends { margin: 20px; }
        #game { display: none; }
        table { margin: auto; border-collapse: collapse; }
        td { width: 50px; height: 50px; text-align: center; vertical-align: middle; }
        .black { background: black; }
        .white { background: white; }
        .piece { font-size: 30px; cursor: pointer; }
        .red { color: red; }
        .black-piece { color: black; }
        .selected { border: 2px solid green; }
        #status { margin: 10px; font-size: 20px; }
        #currency { margin: 10px; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js"></script>
</head>
<body>
    <div id="auth">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Пароль">
        <button onclick="register()">Регистрация</button>
        <button onclick="login()">Вход</button>
        <button onclick="logout()">Выход</button>
    </div>
    <div id="friends" style="display:none;">
        <h3>Друзья</h3>
        <input id="friendEmail" placeholder="Email друга">
        <button onclick="addFriend()">Добавить друга</button>
        <ul id="friendsList"></ul>
        <button onclick="startGame()">Создать игру</button>
        <input id="gameId" placeholder="ID игры друга">
        <button onclick="joinGame()">Присоединиться</button>
    </div>
    <div id="currency"></div>
    <div id="game">
        <h2>Шашки</h2>
        <table id="board"></table>
        <div id="status"></div>
    </div>

    <script>
        // Firebase config (замените на свой)
        const firebaseConfig = {
            apiKey: "AIzaSyD0KfNFPqWV28pULA-H9tKIOqrDg-Q5up4",
            authDomain: "checkers-by-koteyca.firebaseapp.com",
            databaseURL: "https://checkers-by-koteyca-default-rtdb.firebaseio.com",
            projectId: "checkers-by-koteyca",
            storageBucket: "checkers-by-koteyca.firebasestorage.app",
            messagingSenderId: "417731441344",
            appId: "1:417731441344:web:d82e2eadef635148513325"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let user = null;
        let gameRef = null;
        let playerColor = null;
        let board = [];
        let selectedPiece = null;
        let turn = 'red'; // red начинает
        let currency = 0;

        auth.onAuthStateChanged(u => {
            user = u;
            if (user) {
                document.getElementById('auth').style.display = 'none';
                document.getElementById('friends').style.display = 'block';
                loadFriends();
                loadCurrency();
            } else {
                document.getElementById('auth').style.display = 'block';
                document.getElementById('friends').style.display = 'none';
                document.getElementById('game').style.display = 'none';
            }
        });

        function register() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.createUserWithEmailAndPassword(email, pass).catch(console.error);
        }

        function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, pass).catch(console.error);
        }

        function logout() {
            auth.signOut();
        }

        function loadCurrency() {
            db.ref(`users/${user.uid}/currency`).on('value', snap => {
                currency = snap.val() || 0;
                document.getElementById('currency').innerText = `Кошпеички: ${currency}`;
            });
        }

        function updateCurrency(amount) {
            db.ref(`users/${user.uid}/currency`).set(currency + amount);
        }

        function addFriend() {
            const friendEmail = document.getElementById('friendEmail').value;
            // Найти UID по email (для простоты, предполагаем, что email уникален; в реале используйте поиск)
            // Для примера: храним friends по email
            db.ref(`users/${user.uid}/friends`).push(friendEmail);
        }

        function loadFriends() {
            db.ref(`users/${user.uid}/friends`).on('value', snap => {
                const list = document.getElementById('friendsList');
                list.innerHTML = '';
                snap.forEach(child => {
                    const li = document.createElement('li');
                    li.innerText = child.val();
                    list.appendChild(li);
                });
            });
        }

        function startGame() {
            const gameId = Date.now().toString();
            gameRef = db.ref(`games/${gameId}`);
            playerColor = 'red';
            initBoard();
            gameRef.set({ board: board.flat(), turn: 'red', players: [user.uid], status: 'waiting' });
            alert(`ID игры: ${gameId}. Поделитесь с другом.`);
            listenToGame();
            document.getElementById('game').style.display = 'block';
        }

        function joinGame() {
            const gameId = document.getElementById('gameId').value;
            gameRef = db.ref(`games/${gameId}`);
            playerColor = 'black';
            gameRef.child('players').push(user.uid);
            gameRef.update({ status: 'started' });
            listenToGame();
            document.getElementById('game').style.display = 'block';
        }

        function listenToGame() {
            gameRef.on('value', snap => {
                const data = snap.val();
                if (data) {
                    board = [];
                    for (let i = 0; i < 8; i++) {
                        board.push(data.board.slice(i*8, (i+1)*8));
                    }
                    turn = data.turn;
                    renderBoard();
                    checkWin(data);
                    document.getElementById('status').innerText = turn === playerColor ? 'Ваш ход' : 'Ход对手ника';
                }
            });
        }

        function initBoard() {
            board = Array(8).fill().map(() => Array(8).fill(null));
            // Расстановка шашек
            for (let row = 0; row < 3; row++) {
                for (let col = (row % 2 === 0 ? 1 : 0); col < 8; col += 2) {
                    board[row][col] = 'black'; // черные сверху
                }
            }
            for (let row = 5; row < 8; row++) {
                for (let col = (row % 2 === 0 ? 1 : 0); col < 8; col += 2) {
                    board[row][col] = 'red'; // красные снизу
                }
            }
        }

        function renderBoard() {
            const table = document.getElementById('board');
            table.innerHTML = '';
            for (let row = 0; row < 8; row++) {
                const tr = document.createElement('tr');
                for (let col = 0; col < 8; col++) {
                    const td = document.createElement('td');
                    td.className = (row + col) % 2 === 0 ? 'white' : 'black';
                    if (board[row][col]) {
                        const piece = document.createElement('div');
                        piece.className = `piece ${board[row][col]}`;
                        piece.innerText = '⛀'; // Символ шашки (можно изменить)
                        if (board[row][col].includes('king')) piece.innerText = '⛁';
                        piece.onclick = () => selectPiece(row, col);
                        td.appendChild(piece);
                    } else {
                        td.onclick = () => movePiece(row, col);
                    }
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
        }

        function selectPiece(row, col) {
            if (board[row][col] !== playerColor && !board[row][col].startsWith(playerColor)) return;
            if (turn !== playerColor) return;
            selectedPiece = { row, col };
            renderBoard(); // Для выделения, добавьте класс selected в render
            // TODO: Выделите возможные ходы (добавьте логику расчета)
        }

        function movePiece(toRow, toCol) {
            if (!selectedPiece || turn !== playerColor) return;
            // Базовая логика хода (добавьте полные правила: диагональ, прыжки)
            const {row, col} = selectedPiece;
            if (Math.abs(toRow - row) === 1 && Math.abs(toCol - col) === 1 && !board[toRow][toCol]) {
                board[toRow][toCol] = board[row][col];
                board[row][col] = null;
                // Проверка на короля
                if (playerColor === 'red' && toRow === 0) board[toRow][toCol] += '-king';
                if (playerColor === 'black' && toRow === 7) board[toRow][toCol] += '-king';
                // Прыжок (если расстояние 2, удалить середину)
                if (Math.abs(toRow - row) === 2) {
                    const midRow = (row + toRow) / 2;
                    const midCol = (col + toCol) / 2;
                    board[midRow][midCol] = null;
                }
                turn = turn === 'red' ? 'black' : 'red';
                gameRef.update({ board: board.flat(), turn });
            }
            selectedPiece = null;
            renderBoard();
        }

        function checkWin(data) {
            // Проверка на победу (нет шашек оппонента)
            const redCount = board.flat().filter(p => p && p.startsWith('red')).length;
            const blackCount = board.flat().filter(p => p && p.startsWith('black')).length;
            if (redCount === 0) {
                alert('Черные выиграли!');
                updateCurrency(playerColor === 'black' ? 10 : -5);
                gameRef.remove();
            } else if (blackCount === 0) {
                alert('Красные выиграли!');
                updateCurrency(playerColor === 'red' ? 10 : -5);
                gameRef.remove();
            }
        }

        // Инициализация
        renderBoard(); // Для теста, но скрыто
    </script>
</body>
</html>
